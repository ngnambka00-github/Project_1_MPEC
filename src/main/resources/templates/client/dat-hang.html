<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="vn">
<head>
    <meta charset="UTF-8" name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- Chèn icon cho title website -->
    <link rel="icon" th:href="@{/images/logo_white.png}" type="image/x-icon">

    <!-- Link font awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" />

    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">

    <link rel="stylesheet" type="text/css" th:href="@{/styles/style-dathang.css}">

    <title>Shop - Thanh toán</title>
</head>
<body>
    <!-- Nội dung chính của page -->
    <div class="wrapper">
        <div class="main-left">
            <div class="content-top">
                <span class="icon fas fa-chevron-left"></span>
                <a th:href="@{/sanpham}">
                    <img th:src="@{/images/logo_black.png}" alt="logo black">
                </a>
            </div>
            <div class="content-bottom">
                <div class="header">
                    <div class="nav-item">
                        <span>1</span>
                        <span>Đăng nhập</span>
                    </div>
                    <div class="nav-item">
                        <span>2</span>
                        <span>Địa chỉ giao hàng</span>
                    </div>
                    <div class="nav-item">
                        <span>3</span>
                        <span>Thanh toán</span>
                    </div>
                </div>

                <div class="dia-chi">
                    <div class="row mx-0">
                        <div class="col-6 pl-1 pr-2">
                            <div class="form-group">
                                <label for="id-hovaten">Họ và tên</label>
                                <input type="text" class="form-control" id="id-hovaten" placeholder="Nhập họ và tên">
                            </div>
                        </div>
                        <div class="col-6 pl-2 pr-1">
                            <div class="form-group">
                                <label for="id-sodienthoai">Số điện thoại</label>
                                <input type="text" class="form-control" id="id-sodienthoai" placeholder="Nhập số điện thoại">
                            </div>
                        </div>
                    </div>

                    <div class="row mx-0">
                        <div class="col-6 pl-1 pr-2">
                            <div class="form-group">
                                <label for="id-hovaten-nguoinhanho">Họ và tên người nhận hộ (Nếu có)</label>
                                <input type="text" class="form-control" id="id-hovaten-nguoinhanho" placeholder="Nhập họ và tên người nhận hộ - nếu có">
                            </div>
                        </div>
                        <div class="col-6 pl-2 pr-1">
                            <div class="form-group">
                                <label for="exampleInputPassword1">Số điện thoại người nhận hộ (Nếu có)</label>
                                <input type="text" class="form-control" id="exampleInputPassword1" placeholder="Nhập số điện thoại người nhận hộ - nếu có">
                            </div>
                        </div>
                    </div>

                    <div class="row mx-0">
                        <div class="col-6 pl-1 pr-2">
                            <div class="form-group">
                                <label for="id-tinh-thanhpho">Tỉnh / Thành phố</label>
                                <select class="form-control" id="id-tinh-thanhpho">
                                    <option>1</option>
                                    <option>2</option>
                                    <option>3</option>
                                    <option>4</option>
                                    <option>5</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-6 pl-2 pr-1">
                            <div class="form-group">
                                <label for="id-quan-huyen">Quận / Huyện</label>
                                <select class="form-control" id="id-quan-huyen">
                                    <option>1</option>
                                    <option>2</option>
                                    <option>3</option>
                                    <option>4</option>
                                    <option>5</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="row mx-0">
                        <div class="col-6 pl-1 pr-2">
                            <div class="form-group">
                                <label for="id-phuong-xa">Phường / Xã</label>
                                <select class="form-control" id="id-phuong-xa">
                                    <option>1</option>
                                    <option>2</option>
                                    <option>3</option>
                                    <option>4</option>
                                    <option>5</option>
                                </select>
                            </div>
                        </div>
                        <div class="col-6 pl-2 pr-1">
                            <div class="form-group">
                                <label for="id-diachi">Địa chỉ cụ thể</label>
                                <input type="text" class="form-control" id="id-diachi" placeholder="Nhập địa chỉ giao hàng cụ thể">
                            </div>
                        </div>
                    </div>

                    <div class="row mx-0 mt-2">
                        <div class="col-6 pl-1 pr-2">
                            <button class="btn-huybo-diachi">Huy bỏ</button>
                        </div>
                        <div class="col-6 pl-2 pr-1">
                            <button class="btn-xacnhan-diachi">Giao đến dịa chỉ này</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="main-right">
            <div class="content-head">
                <span class="title">Đơn hàng (12 sản phẩm)</span>
            </div>
            <div class="content-middle">
                <div class="item-san-pham">
                    <div class="item-san-pham-img">
                        <img src="https://cdn.boo.vn/products/291/ao-phong-nu-oversized-da-ca-solidtrangwhitetrang-1.jpg" alt="">
                    </div>
                    <div class="item-content">
                        <span class="title-san-pham">ÁO PHÔNG NỮ OVERSIZED DA CÁ</span>
                        <span class="ma-san-pham">Mã: 1.2.02.1.06.010.121.01</span>

                        <div class="option-san-pham">
                            <div class="mau-sac"></div>
                            <div class="size-san-pham">XL</div>
                            <div class="so-luong">
                                <span class="giam-so-luong">-</span>
                                <span class="so-luong-thuc">2</span>
                                <span class="tang-so-luong">+</span>
                            </div>
                        </div>

                        <div class="delete-price">
                            <span class="delete"><i class="far fa-trash-alt"></i></span>
                            <span class="total-money">550,000đ</span>
                        </div>

                        <div class="discount-price none-giam-gia">
							<span class="discount">
								<i class="fas fa-tag"></i>
								<i class="text-giam-gia">Giảm giá</i>
							</span>
                            <span class="total-money">450,000đ</span>
                        </div>
                    </div>
                </div>

                <div class="item-san-pham">
                    <div class="item-san-pham-img">
                        <img src="https://cdn.boo.vn/products/291/ao-phong-nu-oversized-da-ca-solidtrangwhitetrang-1.jpg" alt="">
                    </div>
                    <div class="item-content">
                        <span class="title-san-pham">ÁO PHÔNG NỮ OVERSIZED DA CÁ</span>
                        <span class="ma-san-pham">Mã: 1.2.02.1.06.010.121.01</span>

                        <div class="option-san-pham">
                            <div class="mau-sac"></div>
                            <div class="size-san-pham">XL</div>
                            <div class="so-luong">
                                <span class="giam-so-luong">-</span>
                                <span class="so-luong-thuc">2</span>
                                <span class="tang-so-luong">+</span>
                            </div>
                        </div>

                        <div class="delete-price">
                            <span class="delete"><i class="far fa-trash-alt"></i></span>
                            <span class="total-money">550,000đ</span>
                        </div>

                        <div class="discount-price">
							<span class="discount">
								<i class="fas fa-tag"></i>
								<i class="text-giam-gia">Giảm giá</i>
							</span>
                            <span class="total-money">450,000đ</span>
                        </div>
                    </div>
                </div>

                <div class="item-san-pham">
                    <div class="item-san-pham-img">
                        <img src="https://cdn.boo.vn/products/291/ao-phong-nu-oversized-da-ca-solidtrangwhitetrang-1.jpg" alt="">
                    </div>
                    <div class="item-content">
                        <span class="title-san-pham">ÁO PHÔNG NỮ OVERSIZED DA CÁ</span>
                        <span class="ma-san-pham">Mã: 1.2.02.1.06.010.121.01</span>

                        <div class="option-san-pham">
                            <div class="mau-sac"></div>
                            <div class="size-san-pham">XL</div>
                            <div class="so-luong">
                                <span class="giam-so-luong">-</span>
                                <span class="so-luong-thuc">2</span>
                                <span class="tang-so-luong">+</span>
                            </div>
                        </div>

                        <div class="delete-price">
                            <span class="delete"><i class="far fa-trash-alt"></i></span>
                            <span class="total-money">550,000đ</span>
                        </div>

                        <div class="discount-price none-giam-gia">
							<span class="discount">
								<i class="fas fa-tag"></i>
								<i class="text-giam-gia">Giảm giá</i>
							</span>
                            <span class="total-money">450,000đ</span>
                        </div>
                    </div>
                </div>

                <div class="item-san-pham">
                    <div class="item-san-pham-img">
                        <img src="https://cdn.boo.vn/products/291/ao-phong-nu-oversized-da-ca-solidtrangwhitetrang-1.jpg" alt="">
                    </div>
                    <div class="item-content">
                        <span class="title-san-pham">ÁO PHÔNG NỮ OVERSIZED DA CÁ</span>
                        <span class="ma-san-pham">Mã: 1.2.02.1.06.010.121.01</span>

                        <div class="option-san-pham">
                            <div class="mau-sac"></div>
                            <div class="size-san-pham">XL</div>
                            <div class="so-luong">
                                <span class="giam-so-luong">-</span>
                                <span class="so-luong-thuc">2</span>
                                <span class="tang-so-luong">+</span>
                            </div>
                        </div>

                        <div class="delete-price">
                            <span class="delete"><i class="far fa-trash-alt"></i></span>
                            <span class="total-money">550,000đ</span>
                        </div>

                        <div class="discount-price none-giam-gia">
							<span class="discount">
								<i class="fas fa-tag"></i>
								<i class="text-giam-gia">Giảm giá</i>
							</span>
                            <span class="total-money">450,000đ</span>
                        </div>
                    </div>
                </div>

                <div class="item-san-pham">
                    <div class="item-san-pham-img">
                        <img src="https://cdn.boo.vn/products/291/ao-phong-nu-oversized-da-ca-solidtrangwhitetrang-1.jpg" alt="">
                    </div>
                    <div class="item-content">
                        <span class="title-san-pham">ÁO PHÔNG NỮ OVERSIZED DA CÁ</span>
                        <span class="ma-san-pham">Mã: 1.2.02.1.06.010.121.01</span>

                        <div class="option-san-pham">
                            <div class="mau-sac"></div>
                            <div class="size-san-pham">XL</div>
                            <div class="so-luong">
                                <span class="giam-so-luong">-</span>
                                <span class="so-luong-thuc">2</span>
                                <span class="tang-so-luong">+</span>
                            </div>
                        </div>

                        <div class="delete-price">
                            <span class="delete"><i class="far fa-trash-alt"></i></span>
                            <span class="total-money">550,000đ</span>
                        </div>

                        <div class="discount-price">
							<span class="discount">
								<i class="fas fa-tag"></i>
								<i class="text-giam-gia">Giảm giá</i>
							</span>
                            <span class="total-money">450,000đ</span>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content-footer">
                <div class="khuyen-mai">
                    <input type="text" placeholder="Nhập mã giảm giá...">
                    <button>Nhập</button>
                </div>

                <div class="phi-van-chuyen">
                    <div>
                        <span>Tạm phí</span>
                        <span>8.786.000đ</span>
                    </div>
                    <div>
                        <span>Phí vận chuyển</span>
                        <span>Miễn phí</span>
                    </div>
                </div>

                <div class="tong-tien">
                    <span>Tổng cộng</span>
                    <span>6.787.343đ</span>
                </div>
            </div>
        </div>
    </div>
    <!-- Kết thúc phần nội dung chính của page -->

    <!-- Link thư viện jquery -->
    <script type="text/javascript" th:src="@{/js/jquery-3.6.0.min.js}"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>

    <!-- Link thư viện javascript tự custom -->
    <script type="text/javascript" th:src="@{/js/custom.js}"></script>

    <script type="text/javascript">
        $(document).ready(function() {
            let listGioHang = ajaxGet(`/Project_1/api/getsessiongiohang`);
            updateGioHang(listGioHang);
        });

        // Xóa 1 sản phẩm khỏi giỏi hàng
        $('body').on('click', '.main-right .item-san-pham .delete', function() {
            let idChiTietSanPham = $(this).closest('.item-san-pham').attr('data-id-chi-tiet-san-pham');
            let listGioHang = ajaxGet(`/${nameContentPath}/api/customsession/${idChiTietSanPham}/1`);
            updateGioHang(listGioHang);
        });

        // Tăng số lượng
        $('body').on('click', '.main-right .item-san-pham .so-luong .tang-so-luong', function() {
            let idChiTietSanPham = $(this).closest('.item-san-pham').attr('data-id-chi-tiet-san-pham');
            let listGioHang = ajaxGet(`/${nameContentPath}/api/customsession/${idChiTietSanPham}/2`);
            updateGioHang(listGioHang);
        });

        // Giảm số lượng
        $('body').on('click', '.main-right .item-san-pham .so-luong .giam-so-luong', function() {
            // Kiểm tra số lượng sản phẩm hiện tại
            let soLuong = parseInt($(this).next().text());
            if (soLuong == 1) {
                return;
            }
            let idChiTietSanPham = $(this).closest('.item-san-pham').attr('data-id-chi-tiet-san-pham');
            let listGioHang = ajaxGet(`/${nameContentPath}/api/customsession/${idChiTietSanPham}/3`);
            updateGioHang(listGioHang);
        });

        // Update thông tin của giỏ hàng
        function updateGioHang(listGioHang) {
            let danhSachGioHang = $('.main-right').find('.content-middle');
            let tamPhiTag = $('.main-right').find('.phi-van-chuyen div:nth-child(1) span:nth-child(2)');
            let tongTienTag = $('.main-right').find('.tong-tien span:nth-child(2)');
            let titleGioHangTag = $('.main-right').find('.content-head .title');

            if (listGioHang == null) {
                danhSachGioHang.html('');
                tamPhiTag.html('0đ');
                tongTienTag.html('0đ');
                titleGioHangTag.html('Đơn hàng (0 sản phẩm)');
                return;
            }

            let tongTien = 0;
            let tongSoLuongSanPham = 0;

            // Update frontend list giỏ hang
            let innerItemGioHangText = '';
            for (let gh of listGioHang) {
                tongTien += gh.chiTietSanPham.sanPham.giaSanPham * gh.soLuong;
                tongSoLuongSanPham += gh.soLuong;

                innerItemGioHangText += `
                <div class="item-san-pham" data-id-chi-tiet-san-pham="${gh.chiTietSanPham.idChiTietSanPham}">
                    <div class="item-san-pham-img">
                        <img src="/${nameContentPath}/getimages/images/mau_san_pham/${gh.chiTietSanPham.sanPham.listHinhAnh[0].tenHinhAnh}" alt="">
                    </div>
                    <div class="item-content">
                        <a class="title-san-pham" href="/${nameContentPath}/sanpham/chitiet/${gh.chiTietSanPham.sanPham.idSanPham}">${gh.chiTietSanPham.sanPham.tenSanPham.toUpperCase()}</a>
                        <span class="ma-san-pham">Mã: SP${gh.chiTietSanPham.sanPham.idSanPham}</span>
                        <div class="option-san-pham">
                            <div class="mau-sac" style="background: ${gh.chiTietSanPham.mauSac.maMau}"></div>
                            <div class="size-san-pham">${gh.chiTietSanPham.kichThuoc.kyHieu}</div>
                            <div class="so-luong">
                                <span class="giam-so-luong">-</span>
                                <span class="so-luong-thuc">${gh.soLuong}</span>
                                <span class="tang-so-luong">+</span>
                            </div>
                        </div>

                        <div class="delete-price">
                            <span class="delete"><i class="far fa-trash-alt"></i></span>
                            <span class="total-money">${formatTienTe(gh.chiTietSanPham.sanPham.giaSanPham, 0)}đ</span>
                        </div>

                        <div class="discount-price">
                            <span class="discount">
                                <i class="fas fa-tag"></i>
                                <i class="text-giam-gia">Giảm giá</i>
                            </span>
                            <span class="total-money">000,000đ</span>
                        </div>
                    </div>
                </div>`;
            }

            titleGioHangTag.html(`Đơn hàng (${tongSoLuongSanPham} sản phẩm)`);
            danhSachGioHang.html(innerItemGioHangText);
            tamPhiTag.html(`${formatTienTe(tongTien, 0)}đ`);
            tongTienTag.html(`${formatTienTe(tongTien, 0)}đ`);
        }

        // AJAX GET and return data object
        function ajaxGet(url) {
            let result = null;
            $.ajax({
                url: url,
                type: 'GET',
                contentType: 'application/json',
                async: false,
                timeout:5000,
                success: function(value) {
                    if (typeof(value) == 'string') {
                        value = JSON.parse(value);
                    }
                    result = value;
                }
            });
            return result;
        };

        // Hàm định dạng tiền tệ
        function formatTienTe(num, numFixed) {
            return num.toFixed(numFixed).replace(/./g, function(c, i, a) {
                return i > 0 && c !== "." && (a.length - i) % 3 === 0 ? "," + c : c;
            });
        }
    </script>
</body>
</html>